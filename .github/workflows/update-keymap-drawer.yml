name: Update keymap-drawer (YAML & SVG)

on:
  push:
    paths:
      - "config/**/*.keymap"      # .keymapを更新したら自動実行
      - "config/*.keymap"
  workflow_dispatch: {}           # 手動実行も可

permissions:
  contents: write                 # 生成物をコミットするために必要

jobs:
  build-draw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ★ 重要: Python 3.12 を使う（keymap-drawer の要件を満たす）
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install keymap-drawer
        run: |
          python -m pip install --upgrade pip
          pip install keymap-drawer

      - name: Ensure output dir
        run: mkdir -p keymap-drawer

      # roBa.keymap → YAML
      - name: Generate YAML from .keymap
        run: keymap parse --zmk-keymap config/roBa.keymap -o keymap-drawer/roBa.yaml

      # YAML → SVG
      - name: Generate SVG from YAML
        run: keymap draw keymap-drawer/roBa.yaml -o keymap-drawer/roBa.svg

      # 変更があればコミット＆プッシュ
      - name: Commit changes (if any)
        run: |
          git config user.name  "keymap-bot"
          git config user.email "keymap-bot@users.noreply.github.com"
          git add keymap-drawer/roBa.yaml keymap-drawer/roBa.svg
          if ! git diff --cached --quiet; then
            git commit -m "chore(keymap-drawer): auto-update YAML & SVG from config/roBa.keymap"
            git push
          else
            echo "No changes to commit."
          fi
