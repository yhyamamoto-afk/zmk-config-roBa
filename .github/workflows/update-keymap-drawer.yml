name: Update keymap-drawer (YAML & SVG)

on:
  push:
    paths:
      - "config/**/*.keymap"      # .keymapを更新したら実行
      - "config/*.keymap"
      - "draw.yml"                # 物理レイアウト変更時も再生成
  workflow_dispatch: {}           # 手動実行も可

permissions:
  contents: write                 # 生成物をコミットするために必要

jobs:
  build-draw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # keymap-drawer が要求する Python 3.12 を使用
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install keymap-drawer
        run: |
          python -m pip install --upgrade pip
          pip install keymap-drawer

      - name: Ensure output dir
        run: mkdir -p keymap-drawer

      # roBa.keymap → YAML
      - name: Generate YAML from .keymap
        run: keymap parse --zmk-keymap config/roBa.keymap -o keymap-drawer/roBa.yaml

      # YAML → SVG（★ ここで roBa の物理レイアウト定義 draw.yml を渡す）
      - name: Generate SVG from YAML
        run: keymap draw -c draw.yml keymap-drawer/roBa.yaml -o keymap-drawer/roBa.svg

      # 差分があればコミット
      - name: Commit changes (if any)
        run: |
          git config user.name  "keymap-bot"
          git config user.email "keymap-bot@users.noreply.github.com"
          git add keymap-drawer/roBa.yaml keymap-drawer/roBa.svg
          if ! git diff --cached --quiet; then
            git commit -m "chore(keymap-drawer): auto-update YAML & SVG"
            git push
          else
            echo "No changes to commit."
          fi
