name: Update keymap-drawer (YAML & SVG)

on:
  push:
    paths:
      - "config/**/*.keymap"      # .keymapが更新されたら実行
      - "config/*.keymap"
  workflow_dispatch: {}           # 手動実行も可

permissions:
  contents: write                 # 生成物をコミットするのに必要

jobs:
  build-draw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 重要: tree_sitter を 0.20.1 に固定（0.21系はAPIが変わりエラーになる）
      # keymap-drawer も既知安定版に固定
      - name: Install keymap-drawer toolchain
        run: |
          python -m pip install --upgrade pip
          pip install "tree_sitter==0.20.1"
          pip install "keymap-drawer==0.15.1"

      - name: Ensure output dir
        run: mkdir -p keymap-drawer

      # roBa.keymap → YAML に変換
      # (-z / --zmk-keymap のどちらか。ここではロングオプションを使用)
      - name: Generate YAML from .keymap
        run: keymap parse --zmk-keymap config/roBa.keymap -o keymap-drawer/roBa.yaml

      # YAML → SVG に描画
      - name: Generate SVG from YAML
        run: keymap draw keymap-drawer/roBa.yaml -o keymap-drawer/roBa.svg

      # 差分があればコミット&プッシュ
      - name: Commit changes (if any)
        run: |
          git config user.name  "keymap-bot"
          git config user.email "keymap-bot@users.noreply.github.com"
          git add keymap-drawer/roBa.yaml keymap-drawer/roBa.svg
          if ! git diff --cached --quiet; then
            git commit -m "chore(keymap-drawer): auto-update YAML & SVG from config/roBa.keymap"
            git push
          else
            echo "No changes to commit."
          fi
